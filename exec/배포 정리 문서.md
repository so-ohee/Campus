# ğŸ“„ CampUs ë°°í¬

### IDE
- Visul Studio Code 1.66.0
- IntelliJ IDEA 2021.3.1

### Frontend
- React 17.0.2
- next 12.1.0
- react-bootstrap 2.2.0
- styled-components 5.3.3
- firebase 9.6.1

### Backend
- Django 4.0.3
- SpringBoot 2.5.6
- Gradle 7.4  

### DB / EC2
- MySQL 8.0.28
- Ubuntu 20.04 LTS
- Nginx 1.18.0
- Jenkins 2.332.1

## Django ì‹¤í–‰
#### 1. ê°€ìƒí™˜ê²½ ìƒì„±(ì²˜ìŒ í•œë²ˆë§Œ)
  
```python
python -m venv venv
```
#### 2. ê°€ìƒí™˜ê²½ ì‹¤í–‰

```python
source venv/Scripts/activate
```
#### 3. í•„ìš”í•œ Python íŒ¨í‚¤ì§€ ì„¤ì¹˜

```python
pip install -r requirements.txt
```

#### 4. MySQL í…Œì´ë¸”ë¡œ Django models ìƒì„±

```shell
python manage.py inspectdb > api/models.py
python manage.py makemigrations
python manage.py migrate
```

#### 5. ì„œë²„ ì‹¤í–‰

```
python manage.py runserver
```

## React ì‹¤í–‰
  
```
npm install
npm run dev
```

## ğŸ“Œ ë°°í¬(ë¹Œë“œ) ì‹œ íŠ¹ì´ì‚¬í•­
ì™¸ë¶€ ì„œë¹„ìŠ¤ API Key ë° DB ì ‘ì† ì •ë³´ê°€ í¬í•¨ëœ íŒŒì¼ë“¤ì´ .gitignore ì— ë“±ë¡ë˜ì–´ git ì›ê²© ì €ì¥ì†Œì—ì„œ ì œì™¸ë¨  
í”„ë¡œì íŠ¸ ë¹Œë“œ ë˜ëŠ” ì  í‚¨ìŠ¤ ìë™ ë°°í¬ ì‹œ í•´ë‹¹ íŒŒì¼ë“¤ì„ ë¯¸ë¦¬ ê²½ë¡œì— í¬í•¨í•´ì•¼ í•¨

`backend/spring/src/main/resources/application.yaml`  
![spring](https://user-images.githubusercontent.com/50658153/162027359-d922b0f2-4b7b-4931-96a6-448aad238042.png)

<details>
<summary>application.yaml</summary>
<div markdown="1">

```yaml
server:
  port: 8080

spring:
  datasource:
    driver-class-name: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://j6c103.p.ssafy.io:3306/camping?serverTimezone=Asia/Seoul
    username: USER NAME
    password: PASSWORD
  jpa:
    open-in-view: false
    hibernate:
      ddl-auto:
    properties:
      hibernate:
        format_sql: true
        show-sql: true
cloud:
  aws:
    credentials:
      accessKey: "AWS ACCESS KEY"
      secretKey: "AWS SECRET KYE"
    s3:
      bucket: c103-camping
    region:
      static: ap-northeast-2
    stack:
      auto: false
api:
  naver:
    clientId: "NAVER CLIENT ID"
    clientSecret: "NAVER CLIENT SECRET"

logging.level.com.ssafy.camping: debug
```

</div>
</details>

`frontend/env`  
![django](https://user-images.githubusercontent.com/50658153/162027541-d334f02a-fbe8-445d-b564-6a837147a77e.png)

<details>
<summary>.env</summary>
<div markdown="1">

```
NEXT_PUBLIC_KAKAO_JAVASCRIPT_KEY= ì¹´ì¹´ì˜¤ API í‚¤
```

</div>
</details>

## â­ AWS EC2 ì„¤ì¹˜ í•­ëª©
- Nginx 1.18.0
- MySQL 8.0.28
- openjdk version "11.0.13â€
- node v14.19.1
- npm 6.14.16
- Jenkins 2.332.1
- pip 20.0.2
- certbot 0.40.0

## Jenkins ì„¤ì •
EC2ì— ì  í‚¨ìŠ¤ ì„¤ì¹˜ í›„ í¬íŠ¸ ë³€ê²½(8080 â†’ 8090)  
GitLab í”„ë¡œì íŠ¸ Webhooks ìƒì„± í›„ Execute shell ëª…ë ¹ì–´ ì‘ì„±
```
#!/bin/bash -li
BUILD_ID=dontKillMe

cd backend/spring
chmod +x gradlew
./gradlew clean build

fuser -k 8080/tcp

nohup java -jar /var/lib/jenkins/workspace/PJT/backend/spring/build/libs/Camping-0.0.1-SNAPSHOT.jar &
```
```
cd frontend

#rm -rf .next/ node_modules/next/
npm install

fuser -k 3000/tcp

BUILD_ID=dontKillMe nohup npm run dev &
```
```
#!/bin/bash -li

cd backend/django

pip install -r requirements.txt 

python3 manage.py makemigrations
python3 manage.py migrate

pid=$(netstat -tlnp | grep :8000 | awk '{print $7}')
if [[ $pid == "" ]]; then
 echo "Django is not running!"
else
 echo "Django process killed forcefuilly (pid: $pid)"
 fuser -k 8000/tcp
fi

BUILD_ID=dontKillMe nohup python3 manage.py runserver 0.0.0.0:8000 &

sleep 3s
```

## Nginx ì„¤ì •
SSL ì¸ì¦ì„œ ë°œê¸‰ í›„ ì„¤ì •
```
server {

  # SSL configuration
  #
  listen 443 ssl ;
  listen [::]:443 ssl ;

  ssl_certificate /etc/letsencrypt/live/j6c103.p.ssafy.io/fullchain.pem; # managed by Certbot
  ssl_certificate_key /etc/letsencrypt/live/j6c103.p.ssafy.io/privkey.pem; # managed by Certbot

  ssl_session_cache shared:SSL:1m;
  ssl_session_timeout 10m;
  ssl_ciphers HIGH:!aNULL:!MD5;
  ssl_prefer_server_ciphers on;

  # Add index.php to the list if you are using PHP
  index index.html index.htm index.nginx-debian.html;

  server_name j6c103.p.ssafy.io; # managed by Certbot

    location / {
            
      proxy_set_header Upgrade $http_upgrade;
      proxy_set_header Connection "upgrade";

      proxy_set_header Host $http_host;
      proxy_set_header X-Real-IP $remote_addr;
      proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
      proxy_set_header X-NginX-Proxy true;

      proxy_pass http://localhost:3000;

      proxy_redirect off;
      charset utf-8;
    }

    location /api/ {
      proxy_pass http://localhost:8080/;
    }

    location /django/ {
      proxy_pass http://localhost:8000/;
    }
}
server {
    if ($host = j6c103.p.ssafy.io) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


        listen 80 ;
        listen [::]:80 ;
    server_name j6c103.p.ssafy.io;
    return 404; # managed by Certbot
}
```
